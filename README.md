# Sample playbook for installing and configuring XRay VPN Server, Signal IM Proxy, Squid, and Nginx with SSL from Let's Encrypt

## Overview

This Ansible playbook automates the setup of a server with the following services:

- **Nginx** with automated provisioning of SSL certificates from **Let's Encrypt**
- **Signal IM Proxy Server** with SSL on port `443` (`xxx.my.domain:443`)
- **XRay VPN Server** with SSL on port `8443`
  - Autogenerated connection strings for users
- **Anonymous Proxy** on port `63128` (`xxx.my.domain:63128`)
  - All internet traffic is secured with SSL, ensuring data privacy.

## Prerequisites

1. **Install Ansible on Your Local Machine:**
   - **Linux:** `sudo apt install ansible`
   - **macOS:** `brew install ansible`
   - **Windows:** Refer to the [Ansible documentation](https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html#windows) for installation instructions.

2. **Set Up the Virtual Machine:**
   - Create a VM using your preferred cloud provider with **Debian 12** as the operating system.
   - Obtain the VM's IP address(es), preferably both IPv4 and IPv6 for better accessibility across different networks.

3. **Configure DNS:**
   - Assign a DNS name for both IPv4 and IPv6 (AAAA and A records) as `xxx.my.domain`.
   - If using Cloudflare, ensure proxy mode is disabled.
   - Verify DNS resolution:
     - `ping xxx.my.domain`
     - `ping6 xxx.my.domain`

4. **Secure SSH Access:**
   - Test SSH access to your VM: `ssh root@xxx.my.domain`.
   - **Disable Password Authentication:** Switch to key-based authentication for enhanced security.
     - Generate an SSH key pair: `ssh-keygen`
     - Copy the public key to the VM: `ssh-copy-id root@xxx.my.domain`

5. **Clone the Repository:**
   ```bash
   git clone https://github.com/BestianCode/ansible.playbook.xray_signal_ssl.git
   cd ansible.playbook.xray_signal_ssl
   ```

6. **Setup inventory**
   - Edit `inventory/hosts` file and put your VM IP address(es) there, for example with hostname `vpn01`
     -`vpn01 ansible_host=xxx.my.domain ansible_user=root ansible_port=22`

7. Add your ssh key to the inventory file `inventory/group_vars/all`

  ```yaml
  manager_ssh_keys: |
    ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIETHYQaEzZ/1ThEMdewhwkffTMBtw+hkqd4gut4Oze9l my@ed

  root_ssh_keys: |
    ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIETHYQaEzZ/1ThEMdewhwkffTMBtw+hkqd4gut4Oze9l my@ed
  ```

## Prepare SSL certificates provisioning

* if you use Cloudflare as a DNS provider:
  * You can add your Cloudflare API key to the inventory:
    * `inventory/group_vars/all` - For all hosts
    * OR
    * `inventory/group_vars/vpn` - Only for your VPN servers
    * OR
    * `inventory/host_vars/vpn01` - Personally for this VM host

  ```yaml
  cloudflare_token: "abcdefghijklmnopqrstuvwxyz1234567890ABCD"
  ```

  * List of available zones that you want to have SSL certificates for:

  ```yaml
  letsencrypt_domains:
  - { name: "-d *.my.domain",   email: "my.email@gmail.com", dns_provider: "cloudflare" }
  ```

* if you use another DNS provider:
  * Just add your dns name and email address to the personal VM host inventory file `inventory/host_vars/vpn01`

    ```yaml
    letsencrypt_domains:
    - { name: "-d xxx.my.domain",   email: "my.email@gmail.com", dns_provider: "" }
    ```

## Prepare VPN server configuration

* You can setup DNS name in personal VM host inventory file `inventory/host_vars/vpn01`, or by default it will be set to `ansible hostname`:
    * `xray_dns_name: "xvpn.my.domain"`

## Prepare VPN users UUIDs list

* Prepare list of VPN users with UUID and pu int the inventory:
  * `inventory/group_vars/all` - For all hosts
  * OR
  * `inventory/group_vars/vpn` - Only for your VPN servers
  * OR
  * `inventory/host_vars/vpn01` - Personally for this VM host

* UUIDs can be generated with `uuidgen` command on your local machine.

```yaml
xray_users:
  - { uid: "E6AA699D-8642-4767-8C98-DB93F958A48B", name: "John" }
  - { uid: "39ADD62B-B607-4C56-866F-364F4056EF83", name: "Vika" }
  - { uid: "A1B2C3D4-E5F6-7890-1234-56789ABCDEF0", name: "Michael" }
  - { uid: "B2C3D4E5-F678-9012-3456-789ABCDE1234", name: "Sophia" }
  - { uid: "C3D4E5F6-7890-1234-5678-9ABCDEF12345", name: "David" }
  - { uid: "D4E5F678-9012-3456-789A-BCDEF1234567", name: "Emma" }
  - { uid: "E5F67890-1234-5678-9ABC-DEF123456789", name: "James" }
  - { uid: "F6789012-3456-789A-BCDE-F123456789AB", name: "Olivia" }
  - { uid: "67890123-4567-89AB-CDEF-123456789ABC", name: "Daniel" }
  - { uid: "78901234-5678-9ABC-DEF1-23456789ABCD", name: "Ava" }
```

## Advanced: Extra Inbounds Configuration

You can configure additional inbounds with different protocols and settings. This is useful for:
- Running multiple endpoints on different ports
- Using VLESS-XTLS-Reality for anti-censorship
- Having different user lists per inbound

### WebSocket behind reverse proxy

```yaml
xray_extra_inbounds:
  - port: 8444
    listen: 127.0.0.1
    dns_name: "{{ xray_dns_name }}"
    external_port: 443
    external_dns_name: "vpn.example.com"
    network: ws
    security: none
    path: /maps
    users: "{{ xray_users_vip }}"
```

### VLESS-XTLS-Reality (Recommended for anti-censorship)

Reality provides better obfuscation by mimicking legitimate TLS traffic to popular websites.

1. Generate Reality keys:
   ```bash
   xray x25519
   ```
   This outputs both private and public keys.

2. Generate shortIds:
   ```bash
   openssl rand -hex 4
   ```

3. Configure the inbound:
   ```yaml
   xray_extra_inbounds:
     - port: 44444
       listen: 127.0.0.1
       external_port: 443
       external_dns_name: "vpn.example.com"
       network: tcp
       security: reality
       flow: xtls-rprx-vision
       reality_dest: "www.google.com:443"
       reality_server_names:
         - "www.google.com"
       reality_private_key: "YOUR_PRIVATE_KEY"
       reality_public_key: "YOUR_PUBLIC_KEY"
       reality_short_ids:
         - ""
         - "a1b2c3d4"
       users: "{{ xray_users_vip }}"
   ```

4. Configure HAProxy to forward port 443 to the Reality inbound:
   ```
   frontend main_443
       bind 0.0.0.0:443
       mode tcp
       default_backend be_xray_reality

   backend be_xray_reality
       mode tcp
       server xray 127.0.0.1:44444 check
   ```

### Custom users per inbound

Each inbound can have its own user list:

```yaml
xray_users_vip:
  - { uid: "VIP-UUID-1", name: "VIPUser1" }
  - { uid: "VIP-UUID-2", name: "VIPUser2" }

xray_extra_inbounds:
  - port: 8444
    network: ws
    security: none
    users: "{{ xray_users_vip }}"  # Only VIP users can access this inbound
```

## Optional: Disable main inbound

If you only want to use extra inbounds (e.g., Reality-only setup), comment out `xray_port`:

```yaml
# xray_port: 8443  # Commented out - no main inbound
xray_extra_inbounds:
  - port: 44444
    security: reality
    # ... reality config
```

